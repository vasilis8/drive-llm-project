# ============================================================
# Run Final: "Balanced & Corrected"
# Goal: Working differentiation, No Reward Traps.
# ============================================================

# --- CARLA Server ---
carla:
  host: "localhost"
  port: 2000
  timeout: 30.0
  town: "Town04"
  weather: "ClearNoon"
  fixed_delta_seconds: 0.05

# --- Sensors & Vehicle ---
sensors:
  lidar:
    channels: 1
    range: 50.0
    points_per_second: 56000
    rotation_frequency: 20
    upper_fov: 0.0
    lower_fov: 0.0
    n_beams: 1080
    position: {x: 0.0, y: 0.0, z: 2.4}

vehicle:
  blueprint: "vehicle.tesla.model3"
  max_speed: 40.0

# --- Observation & Action ---
observation:
  lidar_dim: 1080
  command_dim: 384
  vehicle_state_dim: 5

action:
  steering_range: [-1.0, 1.0]
  throttle_range: [-1.0, 1.0]

# --- Rewards (THE FIX) ---
rewards:
  # 1. THE SAFETY NET: Collision is -60. 
  # High enough to prevent suicide runs, but allows calculated risks.
  collision_penalty: -60.0
  
  # 2. BASELINE (Neutral): Balanced driving
  progress_weight: 1.0
  speed_weight: 2.0             
  smoothness_weight: 0.1
  lane_deviation_weight: 0.5    
  max_speed: 40.0
  min_speed_threshold: 2.0
  idle_penalty: -3.0
  alive_bonus: 0.2

  # 3. DIFFERENTIATION
  command_modifiers:
    aggressive:
      # GOAL: Fast & Loose
      speed_weight: 6.0           # INCREASED: Strong push for speed
      speed_bonus_weight: 3.0     # INCREASED: Big bonus for >72km/h
      lane_deviation_weight: 0.0  # Allowed to use full track width
      smoothness_weight: 0.0      # Jerky inputs allowed
      
    defensive:
      # GOAL: Precise & Steady
      speed_weight: 1.0           
      speed_bonus_weight: 0.0     
      lane_deviation_weight: 0.8  # FIX: Reduced from 5.0 to 0.8 (Prevent collapse)
      smoothness_weight: 0.2      # FIX: Reduced from 0.5 to 0.2
      
    neutral: {}

# --- Training ---
training:
  algorithm: "PPO"
  total_timesteps: 2_000_000
  learning_rate: 3.0e-4
  n_steps: 2048
  batch_size: 64
  n_epochs: 10
  gamma: 0.99
  gae_lambda: 0.95
  clip_range: 0.2
  ent_coef: 0.01
  vf_coef: 0.5
  max_grad_norm: 0.5

  # CURRICULUM (Shifted Earlier)
  # Phase 1: Learn to drive (Neutral)
  # Phase 2: Learn to speed (Aggressive) - Starts earlier to prevent "crawling" habit
  # Phase 3: Learn precision (Defensive)
  curriculum:
    neutral_from_step: 0
    aggressive_from_step: 150_000  # EARLIER: Force speed exploration sooner
    defensive_from_step: 400_000   # Standardized

  checkpoint_freq: 50_000
  log_dir: "logs_final_fixed/"
  checkpoint_dir: "checkpoints_final_fixed/"

# --- Model ---
model:
  lidar_cnn:
    channels: [64, 128, 256]
    kernel_sizes: [7, 5, 3]
    strides: [4, 2, 2]
  command_mlp:
    hidden_dim: 128
  fusion_mlp:
    hidden_dims: [256, 128]
  features_dim: 128

evaluation:
  n_episodes: 20
  deterministic: true