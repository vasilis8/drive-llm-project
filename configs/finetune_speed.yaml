# ============================================================
# Language-Conditioned Racing Agent — Run 8 Training Config
# ============================================================
# Strategy: "The Golden Mean"
# Run 6 (Reckless): LR 3e-4, Crash -15. Result: 25 m/s -> Collapse.
# Run 7 (Scared):   LR 1.5e-4, Crash -25. Result: 6 m/s -> Collapse.
# Run 8 (Balanced): LR 2e-4, Crash -20. Target: 18-20 m/s Stable.

# --- CARLA Server ---
carla:
  host: "localhost"
  port: 2000
  timeout: 30.0
  town: "Town04"
  weather: "ClearNoon"
  fixed_delta_seconds: 0.05

# --- Sensors ---
sensors:
  lidar:
    channels: 1
    range: 50.0
    points_per_second: 56000
    rotation_frequency: 20
    upper_fov: 0.0
    lower_fov: 0.0
    n_beams: 1080
    position:
      x: 0.0
      y: 0.0
      z: 2.4

# --- Vehicle ---
vehicle:
  blueprint: "vehicle.tesla.model3"
  max_speed: 40.0

# --- Observation Space ---
observation:
  lidar_dim: 1080
  command_dim: 384
  vehicle_state_dim: 5

# --- Action Space ---
action:
  steering_range: [-1.0, 1.0]
  throttle_range: [-1.0, 1.0]

# --- Reward Design (BALANCED) ---
rewards:
  # Core weights
  progress_weight: 2.0
  speed_weight: 3.0
  smoothness_weight: 0.1
  collision_penalty: -20.0        # BALANCED: -15 (R6) < -20 < -25 (R7)
  lane_deviation_weight: 0.5
  max_speed: 40.0

  # Anti-idle system
  min_speed_threshold: 2.0
  idle_penalty: -3.0

  # High-speed bonus
  speed_bonus_threshold: 0.5
  speed_bonus_weight: 2.0

  # Alive bonus
  alive_bonus: 0.5

  # ── Per-command modifiers ──────────────────────────────────
  command_modifiers:
    aggressive:
      speed_weight: 5.5           # BALANCED: 6.0 (R6) > 5.5 > 5.0 (R7)
      smoothness_weight: 0.05     # Revert to standard (allow some jerk for speed)
      speed_bonus_weight: 4.0
    defensive:
      speed_weight: 2.5
      lane_deviation_weight: 0.5
      speed_bonus_weight: 1.5
    neutral: {}

# --- Training ---
training:
  algorithm: "PPO"
  total_timesteps: 1_000_000      # CHANGED: 2M -> 1M (User request: save time)
  learning_rate: 2.0e-4           # BALANCED: 3e-4 (R6) > 2e-4 > 1.5e-4 (R7)
  n_steps: 2048
  batch_size: 64
  n_epochs: 10
  gamma: 0.99
  gae_lambda: 0.95
  clip_range: 0.2
  ent_coef: 0.01                  # Revert to standard (R7's 0.02 might have confused it)
  vf_coef: 0.5
  max_grad_norm: 0.5

  # Curriculum: Removed
  # curriculum: {}

  # Logging & checkpointing
  checkpoint_freq: 50_000
  log_dir: "logs_v8/"             # CHANGED
  checkpoint_dir: "checkpoints_v8/" # CHANGED

# --- Model Architecture ---
model:
  lidar_cnn:
    channels: [64, 128, 256]
    kernel_sizes: [7, 5, 3]
    strides: [4, 2, 2]
  command_mlp:
    hidden_dim: 128
  fusion_mlp:
    hidden_dims: [256, 128]
  features_dim: 128

# --- Evaluation ---
evaluation:
  n_episodes: 50
  deterministic: true
  save_trajectories: true
